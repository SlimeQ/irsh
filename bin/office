#!/usr/bin/fish

. lib/opts.fish

set base_url "http://ccshrek.duckdns.org:5001"

opts r:d:l $argv

set reg
set dereg
set list

set i 1
while test $i -le (count $flags)
    switch $flags[$i]
        case '-r'
            set i (math $i+1)
            set reg $flags[$i]
        case '-d'
            set i (math $i+1)
            set dereg $flags[$i]
        case '-l'
            set list 1
    end
    set i (math $i+1)
end

echo -n "$NICK: "
if test -n "$reg"
    curl -s -m 2 -d "nick=$NICK&mac=$reg" "$base_url/reg"
else if test -n "$dereg"
    curl -s -m 2 -d "nick=$NICK&mac=$dereg" "$base_url/dereg"
else if test -n "$list"
    curl -s -m 2 "$base_url/list/$NICK"
else
    set around (curl -m 2 -s "$base_url/plain")
    set door (echo -e "door status\r" \
                | nc -w 2 ccshrek.duckdns.org 1357 \
                | sed 's/The office door has been/door/' \
                | sed -e 's/open/\x0309open\x0f/' \
                      -e 's/closed/\x0304closed\x0f/')
    if test -z "$around"
        set around 'no user machines active'
    end
    echo "$around; $door"
end
