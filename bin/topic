#!/usr/bin/fish

. lib/opts.fish

opts nladi: $argv

set n
set load
set add
set del
set ins

set i 1
while test $i -le (count $flags)
    switch $flags[$i]
        case '-n'
            set n 1
        case '-l'
            set load 1
        case '-a'
            set add 1
        case '-d'
            set del 1
        case '-i'
            set i (math $i+1)
            set ins $flags[$i]
    end
    set i (math $i+1)
end

mkdir -p var/topic
touch var/topic/$CHAN

if test -n "$n"
    nl -p -nln -w1 -s' ' var/topic/$CHAN
    exit 0
end

if test -n "$pos"
    set new (echo $pos)
else
    set new (cat)
end
set new (echo $new | tr -d '|\n')

if test -n "$load"
    # pass
else if test -n "$add"
    set f (mktemp)
    echo $new >>$f
    cat var/topic/$CHAN >>$f
    mv $f var/topic/$CHAN
else if test -n "$ins"
    set n (echo $ins | tr -dc '[:digit:]')
    set m (cat var/topic/$CHAN | wc -l)
    if test $n -gt $m
        echo $new >> var/topic/$CHAN
    else
        sed -i "$ins i $new" var/topic/$CHAN
    end
else if test -n "$del"
    set n (echo $pos | tr -dc '[:digit:]')
    sed -i $n'd' var/topic/$CHAN
else
    echo 'error: no operation selected'
    exit 1
end

set topic (cat var/topic/$CHAN | paste -d'|' -s - | sed 's/|/ | /g')

echo TOPIC $CHAN ":$topic" >var/cmd
