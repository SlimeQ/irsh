#!/usr/bin/fish

. lib/sudo.fish
. lib/opts.fish
. lib/sed.fish

opts rs:d: $argv

mkdir -p var/fact

set search
set delete
set with_regexp

set i 1
while test $i -le (count $flags)
    switch $flags[$i]
        case -r
            set with_regexp true
        case -s
            set i (math $i+1)
            set search $flags[$i]
        case -d
            set i (math $i+1)
            set delete $flags[$i]
    end
    set i (math $i+1)
end

if test -n "$search"
    egrep -n $search var/fact/$CHAN
else if test -n "$delete"
    if sudoer
        set n (echo $delete | tr -dc '[:digit:]')
        if test -n $n
            sed -i $n'd' var/fact/$CHAN
        end
    end
else
    if test -n "$with_regexp"
        if sudoer
            set regexp (sed_escape_separator $pos[1])
            set replacement (sed_escape_separator $pos[2])
        end
    else
        set regexp (sed_escape_regexp $pos[1])
        set replacement (sed_escape_replacement $pos[2])
    end
    if test -n "$regexp" -a -n "$replacement"
        echo "s/^$regexp\$/$replacement/p" >> var/fact/$CHAN
    end
end
